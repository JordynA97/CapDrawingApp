<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Draw & Share!</title>
	 <style>
      body{
         background: #eeeeee;
         font-family: tahoma, verdana, sans serif;
      }

      canvas{
         background: #ffffff;
         box-shadow: 4px 4px 8px rgba(0,0,0,0.5);
      }
      
      #controls{
      	margin-top:1em;
      }
      
      #controls button{
      	font-size:1.25em;
      }
      
      #controls button:hover{
      	background-color:lightgray;
      }
     
    </style>
</head>
<body>
	<h1>Draw & Share!</h1>
	<canvas id="canvas" width="350" height="250"></canvas>
	
	<div id="controls">
		<span><button id="clearButton">Clear Canvas</button></span>
		<span><button id="saveButton">Save to Cloud</button></span>
		<span><button id="clearCloudButton">Clear Cloud</button></span>
	</div>
	
	<h2>Saved Drawings</h2>
	<ol id = "drawingList">
	</ol>
	
	<script src="https://www.gstatic.com/firebasejs/5.9.4/firebase.js"></script>
	<script>
	"use strict";
	
	let ctx,dragging=false,lineWidth,strokeStyle;
	let allPoints = [];
	let currentLayer = [];
	
	//firebase
	const DRAWINGPATH = "saveDrawings";
	let allDrawings = {};
	
	initFirebase();
	init();

	// FUNCTIONS
	function init(){
		ctx = canvas.getContext('2d');
		lineWidth = 3;
		strokeStyle = "red";
		
		ctx.lineWidth = lineWidth;
		ctx.strokeStyle = strokeStyle;
		ctx.lineCap = "round"; 
		ctx.lineJoin = "round";
		
		// Hook up event handlers
		canvas.onmousedown = doMousedown;
		canvas.onmousemove = doMousemove;
		canvas.onmouseup = doMouseup;
		canvas.onmouseout = doMouseout;
		clearButton.onclick = doClear;
		saveButton.onclick = doSave;
		clearCloudButton.onclick = doClearCloud;
		window.onhashchange = onLocationHashChanged;
	}
	
	function loadDrawing(points){
		ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
		
		ctx.strokeStyle = strokeStyle;
		ctx.lineWidth = lineWidth;
		
		for(let layer of points){
			ctx.beginPath();
			ctx.moveTo(layer[0].x, layer[0].y);
			
			for(let p of layer){
				ctx.lineTo(p.x, p.y);
				ctx.stroke();
			}
			
			ctx.closePath();
		}
		
	}
	
	// EVENT CALLBACK FUNCTIONS
	function doMousedown(e){
		dragging = true;
		let mouse = getMouse(e);
		ctx.beginPath();
		ctx.moveTo(mouse.x, mouse.y);
		
		//points
		currentLayer.push(mouse);
		allPoints.push(currentLayer);
	}
	
	function doMousemove(e) {
		// bail out if the mouse button is not down
		if(!dragging) return;
		
		// get location of mouse in canvas coordinates
		let mouse = getMouse(e);
		ctx.strokeStyle = strokeStyle;
		ctx.lineWidth = lineWidth;
		
		// draw a line to x,y of mouse
		ctx.lineTo(mouse.x, mouse.y);
		
		// stroke the line
		ctx.stroke();
		
		//points
		currentLayer.push(mouse);

	}
	
	function doMouseup(e) {
		ctx.closePath();
		
		if(dragging){
			//points
			currentLayer = [];
			console.log(allPoints);
			dragging = false;
		}
	}
	
	// if the user drags out of the canvas
	function doMouseout(e) {
	  ctx.closePath();
		
		if(dragging){
			//points
			currentLayer = [];
			console.log(allPoints);
			dragging = false;
		}
		
		//points
		currentLayer = [];
		console.log(allPoints);
	}

	
	function doClear(){
		ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
		allPoints = [];
	}
	
	function doSave(){
		if(allPoints.length == 0) return;
		console.log("doSave");
		firebase.database().ref(DRAWINGPATH).push({
			points: allPoints
		});
	}
	
	function doClearCloud(){
		firebase.database().ref(DRAWINGPATH).remove();
	
	}
	
	function onLocationHashChanged(){
		let key = window.location.hash.substring(1);
		allPoints = allDrawings[key].points;
		loadDrawing(allPoints);
		console.log("changed drawing");
	}
	
	//firebase
	function onDataChanged(data){
		let bigString = "";
		allDrawings = data.val();
		console.log(allDrawings);
		
		if(!allDrawings){
			drawingList.innerHTML = "";
			return;
		}
		
		for(let key of Object.keys(allDrawings)){
			//one set of points
			let drawing = allDrawings[key];
			bigString += `<li><a href = "#${key}"> ${key}</a></li>`;
		}
		
		drawingList.innerHTML = bigString;
	}
	
	function onFirebaseError(error){
		console.log(`ERROR=$(error)`);
	}

// UTILITIES
	function getMouse(e){
		let mouse = {};
		mouse.x = e.pageX - e.target.offsetLeft;
		mouse.y = e.pageY - e.target.offsetTop;
		return mouse;
	}

	//FIREBASE
	function initFirebase(){
	
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyB83TKMW-91E2FNaZzzcOs_7VmnIsPeYWA",
    authDomain: "share-draw-230de.firebaseapp.com",
    databaseURL: "https://share-draw-230de.firebaseio.com",
    projectId: "share-draw-230de",
    storageBucket: "share-draw-230de.appspot.com",
    messagingSenderId: "435389588658",
    appId: "1:435389588658:web:39d0b31b4ab3691e5295ab"
  };
  firebase.initializeApp(config);
  
  console.log(firebase);
  
  firebase.database().ref(DRAWINGPATH).on("value",onDataChanged, onFirebaseError);
 }
	</script>
	
</body>
</html>